# StableVault 本地复现手册

本文档用于在本地完整复现 StableVault 的核心功能，覆盖：
- 合约部署
- 前端交互（Deposit / Mint / Repay / Withdraw）
- Demo Mode 调价
- 自动与手动清算
- Bad Debt 产生与查询
- 后端接口校验

## 1. 前置条件

- 已安装 `foundry`（`anvil/forge/cast`）
- 已安装 `node` 与 `npm`
- 当前仓库路径：`/home/nick/stbcoin`

建议每次复现都开新终端，避免旧环境变量污染。

## 2. 启动本地 Fork 链

在终端 A 执行：

```bash
anvil --fork-url "https://eth-sepolia.g.alchemy.com/v2/U6jYIv7oQtZdCPG8XHpUP" --chain-id 31337
```

默认账户：
- 用户0（keeper）：`0xf39Fd6e51...`
- 用户1（owner）：`0x70997970...`

## 3. 配置约定（当前项目）

当前流程约定：
- `owner = 用户1`
- `keeper = 用户0`
- 业务合约部署在本地 fork
- 价格源走 fork 内的 Chainlink（可用 Demo Mode 覆盖）

## 4. 部署合约到本地 Fork

在终端 B：

```bash
cd /home/nick/stbcoin/contracts
set -a && source ./.env && set +a
forge script script/DeploySepolia.s.sol:DeploySepolia --rpc-url "$RPC_URL" --broadcast
```

读取最新地址（后面要写入后端/前端）：

```bash
jq -r '.transactions[] | select(.transactionType=="CREATE") | "\(.contractName) \(.contractAddress)"' \
  /home/nick/stbcoin/contracts/broadcast/DeploySepolia.s.sol/31337/run-latest.json

jq -r '.receipts[0].blockNumber' \
  /home/nick/stbcoin/contracts/broadcast/DeploySepolia.s.sol/31337/run-latest.json
```

> 注意：每次重启 anvil，链状态重置，需要重新部署并重新写地址。

## 5. 写回 backend/frontend 环境变量

将第 4 步得到的地址写入：

- `backend/.env`
  - `RPC_URL="http://127.0.0.1:8545"`
  - `CHAIN_ID=31337`
  - `START_BLOCK=<部署块号>`
  - `STABLE_VAULT_ADDRESS=<新地址>`
  - `ORACLE_HUB_ADDRESS=<新地址>`
  - `TWAP_ORACLE_ADDRESS=<新地址>`
  - `STB_TOKEN_ADDRESS=<新地址>`
  - `KEEPER_PRIVATE_KEY=0xac0974...ff80`（用户0）

- `frontend/.env`
  - `VITE_STABLE_VAULT_ADDRESS=<新地址>`
  - `VITE_ORACLE_HUB_ADDRESS=<新地址>`
  - `VITE_STB_TOKEN_ADDRESS=<新地址>`
  - `VITE_BACKEND_URL=http://localhost:8080`

- `frontend/.env.local`
  - `VITE_RPC_URL=http://127.0.0.1:8545`
  - `VITE_TARGET_CHAIN_ID=31337`

## 6. 启动后端与前端

终端 C（后端）：

```bash
cd /home/nick/stbcoin/backend
npm run dev
```

终端 D（前端）：

```bash
cd /home/nick/stbcoin/frontend
npm run dev
```

## 7. 钱包准备

前端连接 Metamask（链切到 31337）：
- 测试 admin 功能（Demo Mode）请使用用户1私钥：
  - `0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d`
- keeper 手动清算请使用用户0私钥：
  - `0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80`

## 8. 功能测试清单（前端可测）

### 8.1 Deposit
- 在 `Deposit` 输入 `12`（ETH）
- 成功后 Dashboard `Collateral` 增加

### 8.2 Mint
- 在 `Mint` 输入 `10000`
- 成功后 `Debt` 增加

### 8.3 Repay
- 在 `Repay` 输入 `10000`（或部分）
- 成功后 `Debt` 下降

### 8.4 Withdraw
- 在 `Withdraw` 输入要提取的 ETH
- 若仓位不健康会失败（预期）

### 8.5 Demo Mode + 风险变化
- 使用 owner（用户1）连接钱包
- 在右侧 `Liquidation Control` 调低价格并 `Apply Demo Price`
- 观察 `Health` 从 `Safe` 变 `Danger`

## 9. 功能测试清单（命令行补充）

以下命令用于前端不易稳定复现的部分。

先设置通用变量（终端 B）：

```bash
cd /home/nick/stbcoin/contracts
set -a && source ./.env && set +a

VAULT=<你的 STABLE_VAULT_ADDRESS>
HUB=<你的 ORACLE_HUB_ADDRESS>
STB=<你的 STB_TOKEN_ADDRESS>
OWNER=0x70997970C51812dc3A010C7d01b50e0d17dc79C8
KEEPER=0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
OWNER_PK=0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d
KEEPER_PK=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
RPC=http://127.0.0.1:8545
```

### 9.1 查询仓位与风险状态

```bash
cast call $VAULT "getVault(address)(uint256,uint256,uint256,uint256,uint256,uint256)" $OWNER --rpc-url $RPC
cast call $VAULT "getCollateralRatioBps(address)(uint256)" $OWNER --rpc-url $RPC
cast call $VAULT "isLiquidatable(address)(bool)" $OWNER --rpc-url $RPC
cast call $HUB "getPriceStatus()(uint256,uint256,uint256,uint256,uint256,bool)" --rpc-url $RPC
```

### 9.2 手动触发清算

1) owner 给 keeper 转 STB：

```bash
cast send $STB "transfer(address,uint256)" $KEEPER "$(cast to-wei 2000 ether)" --private-key $OWNER_PK --rpc-url $RPC
```

2) keeper 授权 Vault：

```bash
cast send $STB "approve(address,uint256)" $VAULT "$(cast to-wei 2000 ether)" --private-key $KEEPER_PK --rpc-url $RPC
```

3) keeper 清算 owner：

```bash
cast send $VAULT "liquidate(address,uint256)" $OWNER "$(cast to-wei 1000 ether)" --private-key $KEEPER_PK --rpc-url $RPC
```

### 9.3 强制打出 Bad Debt（用于前端展示）

目标：让仓位在清算后 `collateral=0` 且仍有剩余债务。

```bash
# 把 demo 价格压到极低
cast send $VAULT "setDemoPrice(uint256)" "$(cast to-wei 27 ether)" --private-key $OWNER_PK --rpc-url $RPC

# 再执行一次较大清算
cast send $VAULT "liquidate(address,uint256)" $OWNER "$(cast to-wei 1000 ether)" --private-key $KEEPER_PK --rpc-url $RPC

# 查看系统坏账
cast call $VAULT "getSystemBadDebt()(uint256)" --rpc-url $RPC
```

若返回大于 0，则前端 `Protocol Bad Debt` 应显示非零。

### 9.4 覆盖 Bad Debt（owner）

```bash
# 先看 reserve 与 bad debt
cast call $VAULT "protocolReserveStb()(uint256)" --rpc-url $RPC
cast call $VAULT "getSystemBadDebt()(uint256)" --rpc-url $RPC

# owner 覆盖一部分（示例 1 STB）
cast send $VAULT "coverBadDebt(uint256)" "$(cast to-wei 1 ether)" --private-key $OWNER_PK --rpc-url $RPC
```

## 10. 后端接口校验

```bash
curl -s http://127.0.0.1:8080/health
curl -s http://127.0.0.1:8080/v1/protocol/metrics
curl -s http://127.0.0.1:8080/v1/oracle/status
curl -s http://127.0.0.1:8080/v1/keeper/status
curl -s http://127.0.0.1:8080/v1/vaults/$OWNER
curl -s "http://127.0.0.1:8080/v1/liquidations?limit=20"
```

## 11. 常见问题

### 11.1 `BAD_DATA value: 0x`
- 原因：当前 anvil 会话中该地址没有合约（重启后地址失效）
- 处理：重新部署并更新 `backend/.env`、`frontend/.env`

### 11.2 `eth_getLogs ... Free tier 10 block range`
- 原因：fork 回源到 Alchemy，查询区间过大
- 处理：把 `START_BLOCK` 设为最新部署块，减少 backfill 区间

### 11.3 `Read-only mode` 无法调 Demo
- 原因：当前钱包不是 owner
- 处理：切到 owner（用户1）

### 11.4 `keeper signer unavailable`
- 原因：`KEEPER_PRIVATE_KEY` 未配置
- 处理：在 `backend/.env` 填入 keeper 私钥（当前流程用用户0）

## 12. 一键重开建议顺序

1) 启动 anvil fork  
2) 部署合约  
3) 写回 env 地址  
4) 启动 backend  
5) 启动 frontend  
6) 用 owner 钱包测试 demo mode  
7) 用 keeper/自动 keeper 测清算

